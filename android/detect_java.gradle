def detectJavaHome() {
    // Essayer d'abord JAVA_HOME
    def javaHome = System.getenv('JAVA_HOME')
    if (javaHome) {
        return javaHome
    }

    // Essayer de trouver le chemin via java -version
    def javaExecutable = System.getProperty('os.name').toLowerCase().contains('windows') ? 'java.exe' : 'java'
    def process = new ProcessBuilder(javaExecutable, '-XshowSettings:properties', '-version')
        .redirectErrorStream(true)
        .start()
    
    def output = process.inputStream.text
    def javaHomeMatch = output =~ /java\.home\s*=\s*(.+)/
    if (javaHomeMatch.find()) {
        def detectedPath = javaHomeMatch.group(1)
        println "Chemin Java détecté: $detectedPath"
        
        // Vérifier si le chemin existe
        def javaHomeDir = new File(detectedPath)
        if (javaHomeDir.exists()) {
            return detectedPath
        }
        
        // Essayer de trouver le JDK dans Program Files
        def programFiles = System.getenv('ProgramFiles')
        def possiblePaths = [
            "$programFiles\\Java\\jdk-24.0.1",
            "$programFiles\\Java\\jdk-24.0.1+9-30",
            "$programFiles\\Java\\jdk-24.0.1+9",
            "$programFiles\\Java\\jdk-24.0.1_9",
            "$programFiles\\Java\\jdk-24.0.1_9-30"
        ]
        
        for (path in possiblePaths) {
            def dir = new File(path)
            if (dir.exists()) {
                println "Chemin Java trouvé: $path"
                return path
            }
        }
    }
    
    // Si rien n'est trouvé, essayer le chemin par défaut
    def defaultPath = "C:\\Program Files\\Java\\jdk-24.0.1"
    def defaultDir = new File(defaultPath)
    if (defaultDir.exists()) {
        println "Utilisation du chemin par défaut: $defaultPath"
        return defaultPath
    }
    
    println "Aucun chemin Java valide trouvé"
    return null
}

def javaHome = detectJavaHome()
if (javaHome) {
    println "Java détecté: $javaHome"
    gradle.ext.javaHome = javaHome
    // Définir la propriété pour Gradle
    gradle.startParameter.projectProperties.put('org.gradle.java.home', javaHome)
} else {
    println "Java non détecté, utilisation de la configuration par défaut"
} 